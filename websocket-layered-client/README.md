# åˆ†å±‚ WebSocket å®¢æˆ·ç«¯

åŸºäº TQUIC çš„æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„ WebSocket å®¢æˆ·ç«¯æ¶æ„ï¼Œå®ç°äº†åè®®å±‚ä¸ä¸šåŠ¡é€»è¾‘çš„å®Œå…¨åˆ†ç¦»ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **åˆ†å±‚æ¶æ„** - åè®®å±‚ã€æ¶ˆæ¯å±‚ã€ä¸šåŠ¡å±‚å®Œå…¨è§£è€¦
- **å®æ—¶é€šä¿¡** - åŸºäº JSON çš„é«˜æ€§èƒ½å®æ—¶æ¶ˆæ¯ä¼ è¾“
- **ç¨³å®šå¯é ** - è‡ªåŠ¨é‡è¿ã€å¿ƒè·³æ£€æµ‹ã€é”™è¯¯æ¢å¤
- **æ‰©å±•æ€§å¼º** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œå®šåˆ¶
- **çº¿ç¨‹å®‰å…¨** - æ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¹¶å‘æ“ä½œ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚ (Application)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   èŠå¤©å®¢æˆ·ç«¯     â”‚  â”‚   æ•°æ®åŒæ­¥å®¢æˆ·ç«¯  â”‚  â”‚  è‡ªå®šä¹‰åº”ç”¨ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ ä¸šåŠ¡æ¶ˆæ¯å¤„ç†  â€¢ è®¢é˜…/å‘å¸ƒ  â€¢ è®¤è¯æˆæƒ  â€¢ çŠ¶æ€ç®¡ç†   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   æ¶ˆæ¯å¤„ç†å±‚ (Message Handler)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ JSON åºåˆ—åŒ–  â€¢ æ¶ˆæ¯è·¯ç”±  â€¢ é˜Ÿåˆ—ç®¡ç†  â€¢ è¶…æ—¶å¤„ç†    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   äº‹ä»¶ç³»ç»Ÿå±‚ (Event System)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ å¼‚æ­¥äº‹ä»¶  â€¢ ä¼˜å…ˆçº§é˜Ÿåˆ—  â€¢ å®šæ—¶å™¨  â€¢ çº¿ç¨‹å®‰å…¨      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   åè®®å±‚ (WebSocket Protocol)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ å¸§è§£æ  â€¢ è¿æ¥ç®¡ç†  â€¢ å¿ƒè·³æ£€æµ‹  â€¢ è‡ªåŠ¨é‡è¿        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ä¼ è¾“å±‚ (TQUIC/HTTP3)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ QUIC åè®®  â€¢ HTTP/3  â€¢ TLS 1.3  â€¢ UDP ä¼ è¾“       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
websocket-layered-client/
â”œâ”€â”€ include/                    # å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ websocket_protocol.h    # WebSocket åè®®å±‚
â”‚   â”œâ”€â”€ message_handler.h       # æ¶ˆæ¯å¤„ç†å±‚
â”‚   â”œâ”€â”€ business_logic.h        # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ event_system.h          # äº‹ä»¶ç³»ç»Ÿå±‚
â”‚   â””â”€â”€ layered_websocket_client.h  # ä¸»å®¢æˆ·ç«¯
â”œâ”€â”€ src/                        # æºæ–‡ä»¶
â”‚   â”œâ”€â”€ websocket_protocol.c
â”‚   â”œâ”€â”€ message_handler.c
â”‚   â”œâ”€â”€ business_logic.c
â”‚   â”œâ”€â”€ event_system.c
â”‚   â””â”€â”€ layered_websocket_client.c
â”œâ”€â”€ examples/                   # ç¤ºä¾‹ç¨‹åº
â”‚   â””â”€â”€ chat_client.c          # èŠå¤©å®¢æˆ·ç«¯ç¤ºä¾‹
â”œâ”€â”€ tests/                      # æµ‹è¯•ç¨‹åº
â”œâ”€â”€ CMakeLists.txt             # CMake æ„å»ºæ–‡ä»¶
â””â”€â”€ README.md                  # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

```bash
# Ubuntu/Debian
sudo apt install build-essential cmake pkg-config
sudo apt install libev-dev libcjson-dev libssl-dev

# CentOS/RHEL
sudo yum groupinstall "Development Tools"
sudo yum install cmake libev-devel libcjson-devel openssl-devel
```

### ç¼–è¯‘æ„å»º

```bash
# 1. ç¡®ä¿ TQUIC åº“å·²æ„å»º
cd ../deps/tquic
cargo build --release -F ffi

# 2. æ„å»ºåˆ†å±‚å®¢æˆ·ç«¯
cd ../websocket-layered-client
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### è¿è¡Œç¤ºä¾‹

```bash
# å¯åŠ¨èŠå¤©å®¢æˆ·ç«¯
./bin/chat_client 127.0.0.1 4433 myusername

# å¯ç”¨å‘½ä»¤ï¼š
# /help          - æ˜¾ç¤ºå¸®åŠ©
# /join <é¢‘é“>   - åŠ å…¥é¢‘é“
# /leave <é¢‘é“>  - ç¦»å¼€é¢‘é“
# /list          - åˆ—å‡ºå·²è®¢é˜…é¢‘é“
# /stats         - æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
# /quit          - é€€å‡ºç¨‹åº
```

## ğŸ’¡ æ ¸å¿ƒç‰¹æ€§

### 1. åˆ†å±‚æ¶æ„è®¾è®¡

æ¯ä¸€å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼Œå±‚ä¸å±‚ä¹‹é—´é€šè¿‡æ ‡å‡†æ¥å£é€šä¿¡ï¼š

- **åè®®å±‚**: å¤„ç† WebSocket åè®®ç»†èŠ‚
- **æ¶ˆæ¯å±‚**: å¤„ç† JSON æ¶ˆæ¯çš„åºåˆ—åŒ–å’Œè·¯ç”±
- **ä¸šåŠ¡å±‚**: å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
- **äº‹ä»¶å±‚**: æä¾›å¼‚æ­¥äº‹ä»¶å¤„ç†æœºåˆ¶

### 2. JSON æ¶ˆæ¯æ ¼å¼

æ ‡å‡†åŒ–çš„ JSON æ¶ˆæ¯æ ¼å¼ï¼Œæ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼š

```json
{
  "type": "chat_message",
  "id": "msg_12345",
  "timestamp": 1640995200000,
  "data": {
    "user": "alice",
    "message": "Hello, World!",
    "channel": "general"
  }
}
```

### 3. äº‹ä»¶é©±åŠ¨æ¶æ„

åŸºäºäº‹ä»¶çš„å¼‚æ­¥å¤„ç†æ¨¡å‹ï¼š

```c
// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
layered_client_register_message_handler(client, "chat_message", 
                                       on_chat_message, user_data);

// äº‹ä»¶å¤„ç†å‡½æ•°
void on_chat_message(const message_event_t *event, void *user_data) {
    // å¤„ç†èŠå¤©æ¶ˆæ¯
    printf("æ”¶åˆ°æ¶ˆæ¯: %s\n", event->message->data);
}
```

### 4. è‡ªåŠ¨é‡è¿å’Œå¿ƒè·³

å†…ç½®çš„è¿æ¥ç®¡ç†æœºåˆ¶ï¼š

```c
client_config_t config = layered_client_config_default();
config.auto_reconnect = true;
config.max_reconnect_attempts = 5;
config.heartbeat_interval_ms = 30000;  // 30ç§’å¿ƒè·³
```

### 5. è®¢é˜…/å‘å¸ƒæ¨¡å¼

æ”¯æŒä¸»é¢˜è®¢é˜…å’Œæ¶ˆæ¯å‘å¸ƒï¼š

```c
// è®¢é˜…ä¸»é¢˜
layered_client_subscribe(client, "user_notifications");

// å‘å¸ƒæ¶ˆæ¯
layered_client_publish(client, "chat_general", "Hello everyone!");
```

## ğŸ”§ API ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```c
#include "layered_websocket_client.h"

// äº‹ä»¶å¤„ç†å™¨
void on_client_event(const client_event_t *event, void *user_data) {
    switch (event->type) {
        case CLIENT_EVENT_CONNECTED:
            printf("è¿æ¥æˆåŠŸ\n");
            break;
        case CLIENT_EVENT_MESSAGE_RECEIVED:
            printf("æ”¶åˆ°æ¶ˆæ¯: %s\n", event->message_data);
            break;
        default:
            break;
    }
}

int main() {
    // åˆ›å»ºé…ç½®
    client_config_t config = layered_client_config_default();
    config.host = "127.0.0.1";
    config.port = "4433";
    config.auto_reconnect = true;
    
    // åˆ›å»ºå®¢æˆ·ç«¯
    layered_websocket_client_t *client = 
        layered_client_create(&config, on_client_event, NULL);
    
    // è¿æ¥å¹¶è¿è¡Œ
    layered_client_connect(client);
    layered_client_run(client);
    
    // æ¸…ç†
    layered_client_destroy(client);
    return 0;
}
```

### é«˜çº§åŠŸèƒ½

```c
// å‘é€ä¸šåŠ¡è¯·æ±‚
char *request_id;
layered_client_send_request(client, "get_user_info", 
                           "{\"user_id\": 123}", &request_id);

// è®¢é˜…ä¸»é¢˜
layered_client_subscribe(client, "stock_prices");

// å‘å¸ƒæ¶ˆæ¯
layered_client_publish(client, "notifications", 
                      "{\"type\": \"alert\", \"message\": \"System maintenance\"}");

// è·å–ç»Ÿè®¡ä¿¡æ¯
const client_stats_t *stats = layered_client_get_stats(client);
printf("å‘é€æ¶ˆæ¯æ•°: %llu\n", stats->messages_sent);
printf("å¹³å‡å“åº”æ—¶é—´: %.2f ms\n", stats->avg_response_time_ms);
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•
./tests/test_websocket_protocol
./tests/test_message_handler
./tests/test_event_system
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

- **ä½å»¶è¿Ÿ**: åŸºäº QUIC åè®®çš„å¿«é€Ÿä¼ è¾“
- **é«˜å¹¶å‘**: äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥å¤„ç†
- **å†…å­˜æ•ˆç‡**: é›¶æ‹·è´å’Œå¯¹è±¡æ± æŠ€æœ¯
- **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒæ°´å¹³æ‰©å±•

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **TLS 1.3 åŠ å¯†**: ç«¯åˆ°ç«¯å®‰å…¨ä¼ è¾“
- **æ¶ˆæ¯éªŒè¯**: JSON æ ¼å¼éªŒè¯å’Œæ•°æ®æ ¡éªŒ
- **è¿æ¥è®¤è¯**: æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶
- **é”™è¯¯éš”ç¦»**: å„å±‚ç‹¬ç«‹çš„é”™è¯¯å¤„ç†

## ğŸ¤ æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹

1. åœ¨ä¸šåŠ¡é€»è¾‘å±‚æ³¨å†Œæ–°çš„æ¶ˆæ¯å¤„ç†å™¨
2. å®ç°æ¶ˆæ¯æ„å»ºå’Œè§£æå‡½æ•°
3. æ·»åŠ ç›¸åº”çš„äº‹ä»¶å¤„ç†é€»è¾‘

### é›†æˆæ–°çš„ä¼ è¾“åè®®

1. å®ç°åè®®å±‚æ¥å£
2. æ·»åŠ åè®®ç‰¹å®šçš„é…ç½®é€‰é¡¹
3. æ›´æ–°æ¶ˆæ¯å¤„ç†é€»è¾‘

## ğŸ”„ å¼€å‘çŠ¶æ€

å½“å‰é¡¹ç›®æä¾›äº†å®Œæ•´çš„æ¶æ„è®¾è®¡å’Œæ¥å£å®šä¹‰ï¼Œå„å±‚çš„å…·ä½“å®ç°æ­£åœ¨å¼€å‘ä¸­ï¼š

- âœ… **æ¶æ„è®¾è®¡** - å®Œæˆ
- âœ… **æ¥å£å®šä¹‰** - å®Œæˆ
- âœ… **ç¤ºä¾‹ç¨‹åº** - å®Œæˆ
- ğŸš§ **åè®®å±‚å®ç°** - å¼€å‘ä¸­
- ğŸš§ **æ¶ˆæ¯å¤„ç†å±‚** - å¼€å‘ä¸­
- ğŸš§ **ä¸šåŠ¡é€»è¾‘å±‚** - å¼€å‘ä¸­
- ğŸš§ **äº‹ä»¶ç³»ç»Ÿ** - å¼€å‘ä¸­

### ä¸‹ä¸€æ­¥è®¡åˆ’

1. å®ç° WebSocket åè®®å±‚çš„æ ¸å¿ƒåŠŸèƒ½
2. å®Œæˆ JSON æ¶ˆæ¯å¤„ç†å’Œè·¯ç”±æœºåˆ¶
3. å®ç°äº‹ä»¶ç³»ç»Ÿçš„å¼‚æ­¥å¤„ç†
4. æ·»åŠ å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
5. æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§æµ‹è¯•

## ğŸ“„ è®¸å¯è¯

Apache License 2.0

---

**ğŸ‰ äº«å—æ¨¡å—åŒ–ã€é«˜æ€§èƒ½çš„ WebSocket å®¢æˆ·ç«¯å¼€å‘ä½“éªŒï¼**
